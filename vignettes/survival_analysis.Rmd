---
title: "Survival analysis of the MSK-MetTropism Cohort"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{classify_msk}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>"
)
```

```{r setup}
library(INCOMMON)
library(dplyr)
```

In this example we perform survival analysis using INCOMMON classification of 1742
samples from pancreatic adenocarcinoma (PAAD) patients of the MSK-MetTropsim cohort.

```{r}
data = data_MSK %>% filter(tumor_type == 'PAAD')
print(data)
print(paste0('N samples = ', data$sample %>% unique() %>% length()))
```

First, we classify all the mutations in these samples, exploiting prior knowledge
from PCAWG. In order to retrieve groups with a large enough number of patients to 
achieve statistical significance, we use no cut-off on entropy.

```{r, message=FALSE}
classified_data = lapply((data$sample %>% unique()), function(s){
  
  what = data %>% filter(sample == s)

  x = init(
    mutations = what,
    sample = s,
    tumor_type = unique(what$tumor_type),
    purity = unique(what$purity),
    gene_roles = cancer_gene_census
  )
  
  x = classify(
    x = x,
    priors = pcawg_priors,
    entropy_cutoff = 1,
    rho = 0.01
  )
  
  output = x
  return(output)
})
```
Here, we want to estimate the prognostic power of KRAS mutations with amplification of the mutant allele.  
We first look at the distribution of INCOMMON classes across PAAD samples:

```{r}
plot_class_fraction(x = classified_data, tumor_type = 'PAAD', gene = 'KRAS')
```

Fit survival with Kaplan-Meier.

```{r}
km_fit = kaplan_meier_fit(x = classified_data, tumor_type = 'PAAD', gene = 'KRAS')
km_fit$fit[[1]]
```
Fit survival with multivariate Cox regression.

```{r}
cox_fit(x = classified_data, tumor_type = 'PAAD', gene = 'KRAS', covariates = c('age', 'sex', 'tmb'))
```

Plot survival fit

```{r}
plot_survival_analysis(x = classified_data, tumor_type = 'PAAD', gene = 'KRAS', cox_covariates = c('age', 'sex', 'tmb'))
```





