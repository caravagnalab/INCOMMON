what = classification(msk) %>%
select(gene, gene_role, DP, purity, tumor_type)
get_prior = function(priors, gene, gene_role, tumor_type, k_max){
what = priors %>% filter(gene == !!gene, tumor_type == !!tumor_type)
if(nrow(what) == 0){
what = priors %>% filter(gene == !!gene, tumor_type == 'PANCA')
if(nrow(what) == 0){
if(!is.na(gene_role)){
what = priors %>% filter(gene == 'other genes', gene_role == !!gene_role, tumor_type == 'PANCA')
} else {
what = priors %>% filter(gene == 'other genes', tumor_type == 'PANCA')
}
}
}
what = what %>% filter(ploidy <= k_max)
what$p = what$p/sum(what$p)
what = what %>% dplyr::arrange(ploidy)
return(what)
}
unique(what$gene)
g = "CUL3"
ttypes = what %>% filter(gene == g) %>% pull(tumor_type) %>% unique()
ttypes
ttype = 'CHOL'
gene_role = what %>% filter(gene == g) %>% pull(gene_role) %>% unique()
gene_role
get_prior(priors = priors_k_m, gene = g, gene_role = gene_role, tumor_type = t, k_max = 8) %>%
mutate(tumor_type = t)
priors_k_m
g
gene_role
t
t = 'CHOL'
get_prior(priors = priors_k_m, gene = g, gene_role = gene_role, tumor_type = t, k_max = 8)
get_prior(priors = priors_k_m, gene = g, gene_role = gene_role, tumor_type = t, k_max = 8) %>%
mutate(tumor_type = t)
priors = lapply(unique(what$gene), function(g){
ttypes = what %>% filter(gene == g) %>% pull(tumor_type) %>% unique()
lapply(ttypes, function(t){
gene_role = what %>% filter(gene == g) %>% pull(gene_role) %>% unique()
get_prior(priors = priors_k_m, gene = g, gene_role = gene_role, tumor_type = t, k_max = 8) %>%
mutate(tumor_type = t)
}) %>% do.call(rbind, .)
}) %>% do.call(rbind, .) %>% unique() %>%
group_by(gene, tumor_type, ploidy) %>% reframe(p = sum(p))
priors
get_x = function(N, prior, purity, k){
# p = prior %>% filter(ploidy == k) %>% pull(p) %>% sum()
# N * p / (k * purity + 2 * (1-purity))
N * prior / (k * purity + 2 * (1-purity))
}
output = left_join(what, priors) %>%
mutate(x = get_x(N = DP, prior = p, purity = purity, k = ploidy))
output
g = 'KDM5C'
t
get_prior(priors = priors_k_m, gene = g, gene_role = gene_role, tumor_type = t, k_max = 8) %>%
mutate(tumor_type = t)
priors = lapply(unique(what$gene), function(g){
ttypes = what %>% filter(gene == g) %>% pull(tumor_type) %>% unique()
lapply(ttypes, function(t){
gene_role = what %>% filter(gene == g) %>% pull(gene_role) %>% unique()
get_prior(priors = priors_k_m, gene = g, gene_role = gene_role, tumor_type = t, k_max = 8) %>%
mutate(tumor_type = t, gene = g)
}) %>% do.call(rbind, .)
}) %>% do.call(rbind, .) %>% unique() %>%
group_by(gene, tumor_type, ploidy) %>% reframe(p = sum(p))
priors
get_x = function(N, prior, purity, k){
# p = prior %>% filter(ploidy == k) %>% pull(p) %>% sum()
# N * p / (k * purity + 2 * (1-purity))
N * prior / (k * purity + 2 * (1-purity))
}
output = left_join(what, priors) %>%
mutate(x = get_x(N = DP, prior = p, purity = purity, k = ploidy))
output
what = classification(msk) %>%
select(sample, gene, gene_role, DP, purity, tumor_type)
what
output = left_join(what, priors) %>%
mutate(x = get_x(N = DP, prior = p, purity = purity, k = ploidy))
output
prior_x
prior_x = readRDS( './results/higher_ploidy/msk_overall_x_prior.rds')
output %>%
group_by(sample, gene) %>%
reframe(x = sum(x))
output %>%
group_by(sample, gene) %>%
reframe(x = sum(x)) %>%
group_by(sample) %>%
reframe(x = mean(x))
output %>%
group_by(sample, gene) %>%
reframe(x = sum(x)) %>%
group_by(sample) %>%
reframe(x = mean(x)) %>%
ggplot(aes(x=x))+geom_histogram()
output %>%
group_by(sample, gene) %>%
reframe(x = sum(x)) %>%
group_by(sample) %>%
reframe(x = mean(x)) %>%
ggplot(aes(x=x))+geom_histogram(bins = 100)
x
x = output %>%
group_by(sample, gene) %>%
reframe(x = sum(x)) %>%
group_by(sample) %>%
reframe(x = mean(x))
x
x = output %>%
group_by(sample, gene) %>%
reframe(x = sum(x), DP) %>%
group_by(sample) %>%
reframe(x = mean(x), mdp = median(dp))
x = output %>%
group_by(sample, gene) %>%
reframe(x = sum(x), DP) %>%
group_by(sample) %>%
reframe(x = mean(x), MDP = median(DP))
x
x %>%
ggplot(aes(x = MDP, y = x))+geom_point()
q = quantile(x$MDP)
q
q = quantile(x$MDP, probs = seq(0,1,0.1))
q
q = quantile(x$MDP, probs = seq(0,1,0.2))
q
mean(x$x)
prior_x$mean_x
var(x$x)
prior_x$var_x
q
q = quantile(x$MDP, probs = seq(0,1,0.1))
q
x
x %>%
mutate(
quantile = cut(
MDP,
breaks = c(-Inf, quantile_breaks, Inf),
labels = paste0("Q", 0:length(quantile_breaks)),
include.lowest = TRUE
))
x %>%
mutate(
quantile = cut(
MDP,
breaks = c(-Inf, quantile_breaks, Inf),
labels = paste0("Q", 0:length(q)),
include.lowest = TRUE
))
x %>%
mutate(
quantile = cut(
MDP,
breaks = c(-Inf, q, Inf),
labels = paste0("Q", 0:length(q)),
include.lowest = TRUE
))
q
x %>%
mutate(
quantile = cut(
MDP,
breaks = c(-Inf, q, Inf),
labels = paste0("Q", 1:length(q)),
include.lowest = TRUE
))
x %>%
mutate(
quantile = cut(
MDP,
breaks = c(-Inf, q, Inf),
labels = paste0("Q", 0:length(q)),
include.lowest = TRUE
))
x = x %>%
mutate(
quantile = cut(
MDP,
breaks = c(-Inf, q, Inf),
labels = paste0("Q", 0:length(q)),
include.lowest = TRUE)
)
x %>%
ggplot(aes(x = MDP, y = x))+geom_point()
prior_x
x %>%
group_by(quantile) %>%
reframe(mean_x = mean(x), var_x = var(x))
x %>%
group_by(quantile) %>%
reframe(mean_x = mean(x, na.rm = T), var_x = var(x, na.rm = T))
alpha_beta_pi = function(purity_mean, purity_variance){
alpha_pi = purity_mean * (((purity_mean * (1 - purity_mean)) / (purity_variance)) - 1)
beta_pi = (1 - purity_mean) * (((purity_mean * (1 - purity_mean)) / (purity_variance)) - 1)
return(c('alpha' = alpha_pi, 'beta' = beta_pi))
}
x %>%
group_by(quantile) %>%
reframe(mean_x = mean(x, na.rm = T), var_x = var(x, na.rm = T))
x %>%
group_by(quantile) %>%
reframe(mean_x = mean(x, na.rm = T), var_x = var(x, na.rm = T)) %>%
mutate(
alpha_x = (mean_x**2)/var_x
beta_x = mean_x/var_x
x %>%
group_by(quantile) %>%
reframe(mean_x = mean(x, na.rm = T), var_x = var(x, na.rm = T)) %>%
mutate(
alpha_x = (mean_x**2)/var_x,
beta_x = mean_x/var_x
)
x
x %>%
group_by(quantile) %>%
reframe(mean_x = mean(x, na.rm = T), var_x = var(x, na.rm = T)) %>%
mutate(
alpha_x = (mean_x**2)/var_x,
beta_x = mean_x/var_x
) %>%
ggplot()+
geom_line(aes(x = 1:1000, y = dgamma(x = 1:1000, shape = alpha_x, rate = beta_x)))
x
prior_x = x %>%
group_by(quantile) %>%
reframe(mean_x = mean(x, na.rm = T), var_x = var(x, na.rm = T)) %>%
mutate(
alpha_x = (mean_x**2)/var_x,
beta_x = mean_x/var_x
)
prior_x
prior_x
lapply(1:nrow(prior_x), function(i){
tibble(
x = 1:1000,
y = dgamma(1:1000, shape = prior_x[i,]$alpha_x, rate = prior_x[i,]$beta_x),
quantile = prior_x[i,]$quantile
)
}) %>% do.call(rbind, .)
prior_x
lapply(2:nrow(prior_x), function(i){
tibble(
x = 1:1000,
y = dgamma(1:1000, shape = prior_x[i,]$alpha_x, rate = prior_x[i,]$beta_x),
quantile = prior_x[i,]$quantile
)
}) %>% do.call(rbind, .)
toplot = lapply(2:nrow(prior_x), function(i){
tibble(
x = 1:1000,
y = dgamma(1:1000, shape = prior_x[i,]$alpha_x, rate = prior_x[i,]$beta_x),
quantile = prior_x[i,]$quantile
)
}) %>% do.call(rbind, .)
toplot %>%
ggplot()+geom_line(aes(x = x, y = y))+facet_wrap(~quantile)
toplot %>%
ggplot()+geom_line(aes(x = x, y = y))+facet_wrap(~quantile, scales = 'free')
x
x %>% group_by(quantile) %>% reframe(n=n())
x %>% group_by(quantile) %>% reframe(n=n()) %>% pull(n) %>% sum()
x %>% group_by(quantile) %>% reframe(n=n(), MDP)
x %>% group_by(quantile) %>% reframe(n=n())
distro = x %>% group_by(quantile) %>% reframe(n=n())
distro$val = q
distro
output
x
what
x %>% left_join(what %>% select(sample, tumor_type) %>% unqiue())
x %>% left_join(what %>% select(sample, tumor_type) %>% unique())
x %>% left_join(what %>% select(sample, tumor_type) %>% unique()) %>%
select(quantile, tumor_type) %>% table()
x %>% left_join(what %>% select(sample, tumor_type) %>% unique()) %>%
select(quantile, tumor_type) %>% table() %>% as.tibble()
x %>% left_join(what %>% select(sample, tumor_type) %>% unique()) %>%
select(quantile, tumor_type) %>% table() %>% as.tibble() %>% tidyr::pivot_wider(names_from = quantile, values_from = n)
x %>% left_join(what %>% select(sample, tumor_type) %>% unique()) %>%
select(quantile, tumor_type) %>% table() %>% as.tibble() %>% tidyr::pivot_wider(names_from = quantile, values_from = n) %>%
View()
x %>% left_join(what %>% select(sample, tumor_type) %>% unique()) %>%
select(quantile, tumor_type) %>% table() %>% as.tibble()
x %>% left_join(what %>% select(sample, tumor_type) %>% unique()) %>%
select(quantile, tumor_type) %>% table() %>% as.tibble() %>%
ggplot(aes(x = tumor_type, y = n))+geom_bar()+facet_wrap(~tumor_type)
x %>% left_join(what %>% select(sample, tumor_type) %>% unique()) %>%
select(quantile, tumor_type) %>% table() %>% as.tibble() %>%
ggplot(aes(x = tumor_type, y = n))+geom_bar(stat = 'identity')+facet_wrap(~tumor_type)
x %>% left_join(what %>% select(sample, tumor_type) %>% unique()) %>%
select(quantile, tumor_type) %>% table() %>% as.tibble() %>%
ggplot(aes(x = tumor_type, y = n))+geom_bar(stat = 'identity')+
facet_wrap(~tumor_type, scales = 'free')
x %>% left_join(what %>% select(sample, tumor_type) %>% unique()) %>%
select(quantile, tumor_type) %>% table() %>% as.tibble() %>%
ggplot(aes(x = quantile, y = n))+geom_bar(stat = 'identity')+
facet_wrap(~tumor_type, scales = 'free')
x %>% left_join(what %>% select(sample, tumor_type) %>% unique()) %>%
select(quantile, tumor_type) %>% table() %>% as.tibble() %>%
ggplot(aes(x = quantile, y = n))+geom_bar(stat = 'identity')+
facet_wrap(~tumor_type)
x %>% left_join(what %>% select(sample, tumor_type) %>% unique()) %>%
filter(tumor_type %in% c('BLCA', 'BRCA', 'CRC', 'LUAD', 'OV','PAAD', 'PRAD', 'UCEC')) %>%
select(quantile, tumor_type) %>% table() %>% as.tibble() %>%
ggplot(aes(x = quantile, y = n))+geom_bar(stat = 'identity')+
facet_wrap(~tumor_type)
x %>% left_join(what %>% select(sample, tumor_type) %>% unique()) %>%
filter(tumor_type %in% c('BLCA', 'BRCA', 'CRC', 'LUAD', 'MEL', 'OV','PAAD', 'PRAD', 'UCEC')) %>%
select(quantile, tumor_type) %>% table() %>% as.tibble() %>%
ggplot(aes(x = quantile, y = n))+geom_bar(stat = 'identity')+
facet_wrap(~tumor_type)
x %>% left_join(what %>% select(sample, tumor_type) %>% unique()) %>%
filter(tumor_type %in% c('BLCA', 'BRCA', 'CRC', 'LUAD', 'MEL', 'OV','PAAD', 'PRAD', 'UCEC')) %>%
select(quantile, tumor_type) %>% table() %>% as.tibble() %>%
ggplot(aes(x = quantile, y = n))+geom_bar(stat = 'identity')+
facet_wrap(~tumor_type)+
my_ggplot_theme()
plot_ttype_bias = x %>% left_join(what %>% select(sample, tumor_type) %>% unique()) %>%
filter(tumor_type %in% c('BLCA', 'BRCA', 'CRC', 'LUAD', 'MEL', 'OV','PAAD', 'PRAD', 'UCEC')) %>%
select(quantile, tumor_type) %>% table() %>% as.tibble() %>%
ggplot(aes(x = quantile, y = n))+geom_bar(stat = 'identity')+
facet_wrap(~tumor_type)+
ylab('N Samples')+
my_ggplot_theme()
plot_ttype_bias
x
toplot %>%
ggplot()+geom_line(aes(x = x, y = y))+facet_wrap(~quantile, scales = 'free')
toplot %>%
ggplot()+geom_line(aes(x = x, y = y, color = quantile, group = quantile))
toplot %>%
ggplot()+geom_line(aes(x = x, y = y, color = quantile, group = quantile))+
my_ggplot_theme()
plot_beta = toplot %>%
ggplot()+geom_line(aes(x = x, y = y, color = quantile, group = quantile))+
my_ggplot_theme()
library(patchwork)
plot_beta+plot_ttype_bias
plot_beta/plot_ttype_bias
plot_beta = toplot %>%
ggplot()+geom_line(aes(x = x, y = y, color = quantile, group = quantile))+
xlabel('Prior Pr(x)')+
my_ggplot_theme()
plot_beta = toplot %>%
ggplot()+geom_line(aes(x = x, y = y, color = quantile, group = quantile))+
xlab('Prior Pr(x)')+
my_ggplot_theme()
plot_beta/plot_ttype_bias
plot_beta = toplot %>%
ggplot()+geom_line(aes(x = x, y = y, color = quantile, group = quantile))+
ylab('Prior Pr(x)')+
my_ggplot_theme()
library(patchwork)
plot_beta/plot_ttype_bias
x
toplot
prior_x
saveRDS(
prior_x,
file = './results/higher_ploidy/msk_overall_x_prior_by_dp_quantile.rds'
)
prior_x
x
prior_x = x %>%
group_by(quantile) %>%
reframe(mean_x = mean(x, na.rm = T), var_x = var(x, na.rm = T), MDP) %>%
mutate(
alpha_x = (mean_x**2)/var_x,
beta_x = mean_x/var_x
)
prior_x
prior_x = x %>%
group_by(quantile) %>%
reframe(mean_x = mean(x, na.rm = T), var_x = var(x, na.rm = T), median_DP) %>%
mutate(
alpha_x = (mean_x**2)/var_x,
beta_x = mean_x/var_x
)
prior_x = x %>%
group_by(quantile) %>%
reframe(mean_x = mean(x, na.rm = T), var_x = var(x, na.rm = T), median_DP = MDP) %>%
mutate(
alpha_x = (mean_x**2)/var_x,
beta_x = mean_x/var_x
)
prior_x
saveRDS(
prior_x,
file = './results/higher_ploidy/msk_overall_x_prior_by_dp_quantile.rds'
)
prior_x = x %>%
group_by(quantile) %>%
reframe(mean_x = mean(x, na.rm = T), var_x = var(x, na.rm = T), median_DP = q) %>%
mutate(
alpha_x = (mean_x**2)/var_x,
beta_x = mean_x/var_x
)
prior_x
q
x %>%
group_by(quantile) %>%
reframe(mean_x = mean(x, na.rm = T), var_x = var(x, na.rm = T))
x
q
prior_x
prior_x = x %>%
group_by(quantile) %>%
reframe(mean_x = mean(x, na.rm = T), var_x = var(x, na.rm = T)) %>%
mutate(
alpha_x = (mean_x**2)/var_x,
beta_x = mean_x/var_x
)
prior_x
prior_x$DP = q
prior_x
saveRDS(
prior_x,
file = './results/higher_ploidy/msk_overall_x_prior_by_dp_quantile.rds'
)
prior_x
x %>%
group_by(quantile) %>%
reframe(mean_x = mean(x, na.rm = T), var_x = var(x, na.rm = T))
x %>%
group_by(quantile) %>%
reframe(mean_x = mean(x, na.rm = T), var_x = var(x, na.rm = T)) %>%
#   mutate(
#     alpha_x = (mean_x**2)/var_x,
#     beta_x = mean_x/var_x
# )
mutate(var_x = c(diff(DP), NA))
redefine_var_x = function(df) {
df$var_x <- c(diff(df$DP), NA) # Calculate the difference between DP values
return(df)
}
prior_x = x %>%
group_by(quantile) %>%
reframe(mean_x = mean(x, na.rm = T), var_x = var(x, na.rm = T))
redefine_var_x(prior_x)
prior_x
i = 1
prior_x[i,]
prior_x[i,]
i = 2
prior_x[i,]
prior_x[i,]$DP-prior_x[i-1,]$DP
#   mutate(
#     alpha_x = (mean_x**2)/var_x,
#     beta_x = mean_x/var_x
# )
prior_x$DP = q
prior_x
prior_x[i,]$DP-prior_x[i-1,]$DP
(prior_x[i,]$DP-prior_x[i-1,]$DP)/prior_x[i-1,]$DP
((prior_x[i,]$DP-prior_x[i-1,]$DP)/prior_x[i-1,]$DP)*100
prior_x$alt_var_x = NA
lapply(2:nrow(prior_x), function(i){
prior_x[i,]$alt_var_x = ((prior_x[i,]$DP-prior_x[i-1,]$DP)/prior_x[i-1,]$DP)*100
}) %>% do.call(rbind, .)
for(i in 2:nrow(prior_x)){
prior_x[i,]$alt_var_x = ((prior_x[i,]$DP-prior_x[i-1,]$DP)/prior_x[i-1,]$DP)*100
}
prior_x
prior_x %>%
mutate(
alpha_x = (mean_x**2)/var_x,
beta_x = mean_x/var_x
)
prior_x = prior_x %>%
mutate(
alpha_x = (mean_x**2)/var_x,
beta_x = mean_x/var_x
)
toplot = lapply(2:nrow(prior_x), function(i){
tibble(
x = 1:1000,
y = dgamma(1:1000, shape = prior_x[i,]$alpha_x, rate = prior_x[i,]$beta_x),
quantile = prior_x[i,]$quantile
)
}) %>% do.call(rbind, .)
plot_beta = toplot %>%
ggplot()+geom_line(aes(x = x, y = y, color = quantile, group = quantile))+
ylab('Prior Pr(x)')+
my_ggplot_theme()
plot_beta
prior_x
prior_x = prior_x %>%
mutate(
alpha_x = (mean_x**2)/alt_var_x,
beta_x = mean_x/alt_var_x
)
toplot = lapply(2:nrow(prior_x), function(i){
tibble(
x = 1:1000,
y = dgamma(1:1000, shape = prior_x[i,]$alpha_x, rate = prior_x[i,]$beta_x),
quantile = prior_x[i,]$quantile
)
}) %>% do.call(rbind, .)
plot_beta = toplot %>%
ggplot()+geom_line(aes(x = x, y = y, color = quantile, group = quantile))+
ylab('Prior Pr(x)')+
my_ggplot_theme()
plot_beta
saveRDS(
prior_x,
file = './results/higher_ploidy/msk_overall_x_prior_by_dp_quantile.rds'
)
out
