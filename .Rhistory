rename(p.value = value)) %>%
mutate(var = case_when(
grepl('group', var) ~ gsub(pattern = 'group', replacement = '', var),
grepl('Sex', var) ~ gsub(pattern = 'Sex', replacement = 'Sex: ', var),
TRUE ~ var
)) %>%
mutate(tumor_type = tumor_type,
gene = gene,
n_samples = n_samples,
method = method)
}) %>% do.call(rbind, .)
}) %>% do.call(rbind, .)
}) %>% do.call(rbind, .) %>% as_tibble()
saveRDS(cox_table,
file = paste0(
'./results/cox_tables/',
filename,
paste(covariates, collapse = '_'),
'_with_LOH_oncogenes.rds'
)
)
}
survival_analysis = function(x, covariates, filename){
what = get_cases(x)
x = rename_covariates(x)
for(tumor_type in unique(what$tumor_type)){
genes = what %>%
filter(tumor_type == !!tumor_type) %>%
pull(gene) %>% unique()
new_covariates = covariates
if(tumor_type %in% c('BRCA', 'PRAD', 'UCEC')) new_covariates = setdiff(covariates, 'Sex')
for(gene in genes){
tryCatch(
{
min.n = INCOMMON:::prepare_km_fit_input(x = x,
tumor_type = tumor_type,
gene = gene) %>%
pull(class) %>%
table() %>%
min()
if(min.n <= 30) return(NULL)
# Fit KM
x = kaplan_meier_fit(
x = x,
tumor_type = tumor_type,
gene = gene,
survival_time = 'OS_MONTHS',
survival_status = 'OS_STATUS'
)
# Fit Cox
x = cox_fit(
x = x,
tumor_type = tumor_type,
gene = gene,
survival_time = 'OS_MONTHS',
survival_status = 'OS_STATUS',
covariates = new_covariates,
tmb_method = ">10"
)
# Plot surv analysis
plot_summary_survival = plot_survival_analysis(
x = x,
tumor_type = tumor_type,
gene = gene,
cox_covariates = new_covariates
)
# saveRDS(object = plot_summary_survival,
#         file = paste0('./plots/survival_summaries/multivariate_new_model/', tumor_type, '_', gene, '.rds'))
ggsave(
plot = plot_summary_survival,
filename = paste0('./figures/Other/survival_summaries/multivariate_new_model/with_LOH_oncogenes/', tumor_type, '_', gene, '_', paste(covariates, collapse = '_'), '.pdf'),
create.dir = TRUE,
width = 8,
height = 5)
}, error = function(e){
return(NULL)
}
)
}
}
cox_table(x, filename)
}
covariates = c("Sex", "TMB", 'Age', 'Sample')
survival_analysis(x = msk, covariates = covariates, filename = 'msk_cox_table_')
survival_analysis
survival_analysis %>% View()
x = msk,
x = msk
filename = 'msk_cox_table_'
what = get_cases(x)
x = rename_covariates(x)
for(tumor_type in unique(what$tumor_type)){
genes = what %>%
filter(tumor_type == !!tumor_type) %>%
pull(gene) %>% unique()
new_covariates = covariates
if(tumor_type %in% c('BRCA', 'PRAD', 'UCEC')) new_covariates = setdiff(covariates, 'Sex')
for(gene in genes){
tryCatch(
{
min.n = INCOMMON:::prepare_km_fit_input(x = x,
tumor_type = tumor_type,
gene = gene) %>%
pull(class) %>%
table() %>%
min()
if(min.n <= 30) return(NULL)
# Fit KM
x = kaplan_meier_fit(
x = x,
tumor_type = tumor_type,
gene = gene,
survival_time = 'OS_MONTHS',
survival_status = 'OS_STATUS'
)
# Fit Cox
x = cox_fit(
x = x,
tumor_type = tumor_type,
gene = gene,
survival_time = 'OS_MONTHS',
survival_status = 'OS_STATUS',
covariates = new_covariates,
tmb_method = ">10"
)
# Plot surv analysis
plot_summary_survival = plot_survival_analysis(
x = x,
tumor_type = tumor_type,
gene = gene,
cox_covariates = new_covariates
)
# saveRDS(object = plot_summary_survival,
#         file = paste0('./plots/survival_summaries/multivariate_new_model/', tumor_type, '_', gene, '.rds'))
ggsave(
plot = plot_summary_survival,
filename = paste0('./figures/Other/survival_summaries/multivariate_new_model/with_LOH_oncogenes/', tumor_type, '_', gene, '_', paste(covariates, collapse = '_'), '.pdf'),
create.dir = TRUE,
width = 8,
height = 5)
}, error = function(e){
return(NULL)
}
)
}
}
cox_table = function(x, filename){
lapply(names(x$survival), function(tumor_type){
genes = names(x$survival[[tumor_type]])
lapply(genes, function(gene){
# Get total number of samples
n_samples = x$survival[[tumor_type]][[gene]]$`kaplan-meier`[['baseline']]$n[2]
lapply(c('baseline', 'incommon'), function(method){
print(tumor_type)
print(gene)
print(method)
# Get Cox regression
if(!('cox_regression' %in% names(x$survival[[tumor_type]][[gene]]))) return(NULL)
out = x$survival[[tumor_type]][[gene]]$`cox_regression`[[method]]
# Get table of Cox regression coefficients and p.values
s = summary(out)
rnames = s$conf.int %>% rownames()
s$conf.int %>%
as_tibble() %>%
mutate(var = rnames) %>%
select(-2) %>%
rename(value = `exp(coef)`,
upper = `upper .95`,
lower = `lower .95`) %>%
cbind(s$coefficients[, 'Pr(>|z|)'] %>%
as_tibble_col() %>%
rename(p.value = value)) %>%
mutate(var = case_when(
grepl('group', var) ~ gsub(pattern = 'group', replacement = '', var),
grepl('Sex', var) ~ gsub(pattern = 'Sex', replacement = 'Sex: ', var),
TRUE ~ var
)) %>%
mutate(tumor_type = tumor_type,
gene = gene,
n_samples = n_samples,
method = method)
}) %>% do.call(rbind, .)
}) %>% do.call(rbind, .)
}) %>% do.call(rbind, .) %>% as_tibble()
saveRDS(cox_table,
file = paste0(
'./results/cox_tables/',
filename,
paste(covariates, collapse = '_'),
'_with_LOH_oncogenes.rds'
)
)
}
x = msk_h
filename = 'msk_cox_table_hotspots'
what = get_cases(x)
x = rename_covariates(x)
for(tumor_type in unique(what$tumor_type)){
genes = what %>%
filter(tumor_type == !!tumor_type) %>%
pull(gene) %>% unique()
new_covariates = covariates
if(tumor_type %in% c('BRCA', 'PRAD', 'UCEC')) new_covariates = setdiff(covariates, 'Sex')
for(gene in genes){
tryCatch(
{
min.n = INCOMMON:::prepare_km_fit_input(x = x,
tumor_type = tumor_type,
gene = gene) %>%
pull(class) %>%
table() %>%
min()
if(min.n <= 30) return(NULL)
# Fit KM
x = kaplan_meier_fit(
x = x,
tumor_type = tumor_type,
gene = gene,
survival_time = 'OS_MONTHS',
survival_status = 'OS_STATUS'
)
# Fit Cox
x = cox_fit(
x = x,
tumor_type = tumor_type,
gene = gene,
survival_time = 'OS_MONTHS',
survival_status = 'OS_STATUS',
covariates = new_covariates,
tmb_method = ">10"
)
# Plot surv analysis
plot_summary_survival = plot_survival_analysis(
x = x,
tumor_type = tumor_type,
gene = gene,
cox_covariates = new_covariates
)
# saveRDS(object = plot_summary_survival,
#         file = paste0('./plots/survival_summaries/multivariate_new_model/', tumor_type, '_', gene, '.rds'))
ggsave(
plot = plot_summary_survival,
filename = paste0('./figures/Other/survival_summaries/multivariate_new_model/with_LOH_oncogenes/', tumor_type, '_', gene, '_', paste(covariates, collapse = '_'), '.pdf'),
create.dir = TRUE,
width = 8,
height = 5)
}, error = function(e){
return(NULL)
}
)
}
}
cox_table(x, filename)
covariates = c("Sex", "TMB", 'Age', 'Sample', 'FGA')
x = msk
filename = 'msk_cox_table_'
what = get_cases(x)
x = rename_covariates(x)
for(tumor_type in unique(what$tumor_type)){
genes = what %>%
filter(tumor_type == !!tumor_type) %>%
pull(gene) %>% unique()
new_covariates = covariates
if(tumor_type %in% c('BRCA', 'PRAD', 'UCEC')) new_covariates = setdiff(covariates, 'Sex')
for(gene in genes){
tryCatch(
{
min.n = INCOMMON:::prepare_km_fit_input(x = x,
tumor_type = tumor_type,
gene = gene) %>%
pull(class) %>%
table() %>%
min()
if(min.n <= 30) return(NULL)
# Fit KM
x = kaplan_meier_fit(
x = x,
tumor_type = tumor_type,
gene = gene,
survival_time = 'OS_MONTHS',
survival_status = 'OS_STATUS'
)
# Fit Cox
x = cox_fit(
x = x,
tumor_type = tumor_type,
gene = gene,
survival_time = 'OS_MONTHS',
survival_status = 'OS_STATUS',
covariates = new_covariates,
tmb_method = ">10"
)
# Plot surv analysis
plot_summary_survival = plot_survival_analysis(
x = x,
tumor_type = tumor_type,
gene = gene,
cox_covariates = new_covariates
)
# saveRDS(object = plot_summary_survival,
#         file = paste0('./plots/survival_summaries/multivariate_new_model/', tumor_type, '_', gene, '.rds'))
ggsave(
plot = plot_summary_survival,
filename = paste0('./figures/Other/survival_summaries/multivariate_new_model/with_LOH_oncogenes/', tumor_type, '_', gene, '_', paste(covariates, collapse = '_'), '.pdf'),
create.dir = TRUE,
width = 8,
height = 5)
}, error = function(e){
return(NULL)
}
)
}
}
cox_table(x, filename)
covariates
x = msk_h
filename = 'msk_cox_table_hotspots_'
what = get_cases(x)
x = rename_covariates(x)
for(tumor_type in unique(what$tumor_type)){
genes = what %>%
filter(tumor_type == !!tumor_type) %>%
pull(gene) %>% unique()
new_covariates = covariates
if(tumor_type %in% c('BRCA', 'PRAD', 'UCEC')) new_covariates = setdiff(covariates, 'Sex')
for(gene in genes){
tryCatch(
{
min.n = INCOMMON:::prepare_km_fit_input(x = x,
tumor_type = tumor_type,
gene = gene) %>%
pull(class) %>%
table() %>%
min()
if(min.n <= 30) return(NULL)
# Fit KM
x = kaplan_meier_fit(
x = x,
tumor_type = tumor_type,
gene = gene,
survival_time = 'OS_MONTHS',
survival_status = 'OS_STATUS'
)
# Fit Cox
x = cox_fit(
x = x,
tumor_type = tumor_type,
gene = gene,
survival_time = 'OS_MONTHS',
survival_status = 'OS_STATUS',
covariates = new_covariates,
tmb_method = ">10"
)
# Plot surv analysis
plot_summary_survival = plot_survival_analysis(
x = x,
tumor_type = tumor_type,
gene = gene,
cox_covariates = new_covariates
)
# saveRDS(object = plot_summary_survival,
#         file = paste0('./plots/survival_summaries/multivariate_new_model/', tumor_type, '_', gene, '.rds'))
ggsave(
plot = plot_summary_survival,
filename = paste0('./figures/Other/survival_summaries/multivariate_new_model/with_LOH_oncogenes/', tumor_type, '_', gene, '_', paste(covariates, collapse = '_'), '.pdf'),
create.dir = TRUE,
width = 8,
height = 5)
}, error = function(e){
return(NULL)
}
)
}
}
cox_table(x, filename)
covariates = c("Sex", "TMB", 'Age', 'FGA')
x = msk
what = get_cases(x)
x = rename_covariates(x)
for(tumor_type in unique(what$tumor_type)){
genes = what %>%
filter(tumor_type == !!tumor_type) %>%
pull(gene) %>% unique()
new_covariates = covariates
if(tumor_type %in% c('BRCA', 'PRAD', 'UCEC')) new_covariates = setdiff(covariates, 'Sex')
for(gene in genes){
tryCatch(
{
min.n = INCOMMON:::prepare_km_fit_input(x = x,
tumor_type = tumor_type,
gene = gene) %>%
pull(class) %>%
table() %>%
min()
if(min.n <= 30) return(NULL)
# Fit KM
x = kaplan_meier_fit(
x = x,
tumor_type = tumor_type,
gene = gene,
survival_time = 'OS_MONTHS',
survival_status = 'OS_STATUS'
)
# Fit Cox
x = cox_fit(
x = x,
tumor_type = tumor_type,
gene = gene,
survival_time = 'OS_MONTHS',
survival_status = 'OS_STATUS',
covariates = new_covariates,
tmb_method = ">10"
)
# Plot surv analysis
plot_summary_survival = plot_survival_analysis(
x = x,
tumor_type = tumor_type,
gene = gene,
cox_covariates = new_covariates
)
# saveRDS(object = plot_summary_survival,
#         file = paste0('./plots/survival_summaries/multivariate_new_model/', tumor_type, '_', gene, '.rds'))
ggsave(
plot = plot_summary_survival,
filename = paste0('./figures/Other/survival_summaries/multivariate_new_model/with_LOH_oncogenes/', tumor_type, '_', gene, '_', paste(covariates, collapse = '_'), '.pdf'),
create.dir = TRUE,
width = 8,
height = 5)
}, error = function(e){
return(NULL)
}
)
}
}
cox_table(x, filename)
x = msk_h
filename
x
'msk_cox_table_'
cox_table(x, filename)
filename
filename = 'msk_cox_table_'
cox_table(x, filename)
x = msk_h
x
filename = 'msk_cox_table_hotspots_'
what = get_cases(x)
x = rename_covariates(x)
for(tumor_type in unique(what$tumor_type)){
genes = what %>%
filter(tumor_type == !!tumor_type) %>%
pull(gene) %>% unique()
new_covariates = covariates
if(tumor_type %in% c('BRCA', 'PRAD', 'UCEC')) new_covariates = setdiff(covariates, 'Sex')
for(gene in genes){
tryCatch(
{
min.n = INCOMMON:::prepare_km_fit_input(x = x,
tumor_type = tumor_type,
gene = gene) %>%
pull(class) %>%
table() %>%
min()
if(min.n <= 30) return(NULL)
# Fit KM
x = kaplan_meier_fit(
x = x,
tumor_type = tumor_type,
gene = gene,
survival_time = 'OS_MONTHS',
survival_status = 'OS_STATUS'
)
# Fit Cox
x = cox_fit(
x = x,
tumor_type = tumor_type,
gene = gene,
survival_time = 'OS_MONTHS',
survival_status = 'OS_STATUS',
covariates = new_covariates,
tmb_method = ">10"
)
# Plot surv analysis
plot_summary_survival = plot_survival_analysis(
x = x,
tumor_type = tumor_type,
gene = gene,
cox_covariates = new_covariates
)
# saveRDS(object = plot_summary_survival,
#         file = paste0('./plots/survival_summaries/multivariate_new_model/', tumor_type, '_', gene, '.rds'))
ggsave(
plot = plot_summary_survival,
filename = paste0('./figures/Other/survival_summaries/multivariate_new_model/with_LOH_oncogenes/', tumor_type, '_', gene, '_', paste(covariates, collapse = '_'), '.pdf'),
create.dir = TRUE,
width = 8,
height = 5)
}, error = function(e){
return(NULL)
}
)
}
}
cox_table(x, filename)
setwd('~/Documents/GitHub/INCOMMON/')
2-7
2/7
1-7
1/7
1-8
1/8
getwd()
